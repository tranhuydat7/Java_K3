USE layloihoi_db
-- I
-- Câu 1:
SELECT * FROM chi_tiet_su_dung_dv
WHERE SOLUONG > 3 AND SOLUONG < 10;

-- Câu 2:
SELECT * FROM phong;
UPDATE phong
SET GIAPHONG = GIAPHONG + 10.000
WHERE SOKHACHTOIDA > 15;
SELECT * FROM phong;

-- Câu 3:
SELECT * FROM dat_phong;
DELETE FROM dat_phong
WHERE TRANGTHAIDAT = 'DA HUY';
SELECT * FROM dat_phong;

-- II
-- Câu 4:
SELECT TENKH FROM khach_hang
WHERE TENKH REGEXP 'H |N |M' AND CHAR_LENGTH(TENKH) <= 20;

-- Câu 5:
-- Cách 1:
SELECT DISTINCT TENKH FROM khach_hang;
-- Cách 2:
SELECT TENKH FROM khach_hang GROUP BY TENKH;

-- Câu 6:
SELECT * FROM dich_vu_di_kem
WHERE (DONVITINH = 'Lon' AND DONGIA > 10.000) OR (DONVITINH = 'Cai' AND DONGIA < 5000);

-- Câu 7:
SELECT dp.MADATPHONG, dp.MAPHONG, p.LOAIPHONG, p.SOKHACHTOIDA, p.GIAPHONG, kh.MAKH, kh.TENKH, kh.SODT,
		dp.NGAYDAT, dp.GIOBATDAU, dp.GIOKETTHUC, ctsd.MADV MaDichVu, ctsd.SoLuong, dvdk.DONGIA
FROM dat_phong dp JOIN khach_hang kh ON dp.MAKH = kh.MAKH
JOIN chi_tiet_su_dung_dv ctsd ON dp.MADATPHONG = ctsd.MADATPHONG
JOIN dich_vu_di_kem dvdk ON ctsd.MADV = dvdk.MADV
JOIN phong p ON dp.MAPHONG = p.MAPHONG
WHERE p.GIAPHONG > 50.000 AND dp.TRANGTHAIDAT = 'DA DAT' AND (YEAR(dp.NGAYDAT) = 2018 OR YEAR(dp.NGAYDAT) = 2017);

-- III
-- Câu 8:
SELECT dp.MADATPHONG, dp.MAPHONG, p.LOAIPHONG, p.GIAPHONG, kh.TENKH, dp.NGAYDAT, 
		FORMAT((p.GIAPHONG * (HOUR(TIMEDIFF(GIOKETTHUC, GIOBATDAU)) + (MINUTE(TIMEDIFF(GIOKETTHUC, GIOBATDAU)) / 60))), 3) TongTienHat,
        SUM(ctsd.SoLuong * dvdk.DONGIA) TongTienSuDungDichVu,
        FORMAT((p.GIAPHONG * (HOUR(TIMEDIFF(GIOKETTHUC, GIOBATDAU)) + (MINUTE(TIMEDIFF(GIOKETTHUC, GIOBATDAU)) / 60))) + SUM(ctsd.SoLuong * dvdk.DONGIA), 3) TongTienThanhToan
        
FROM dat_phong dp JOIN khach_hang kh ON dp.MAKH = kh.MAKH
JOIN chi_tiet_su_dung_dv ctsd ON dp.MADATPHONG = ctsd.MADATPHONG
JOIN dich_vu_di_kem dvdk ON ctsd.MADV = dvdk.MADV
JOIN phong p ON dp.MAPHONG = p.MAPHONG
GROUP BY dp.MADATPHONG, dp.MAPHONG, p.LOAIPHONG, p.GIAPHONG, kh.TENKH, dp.NGAYDAT;

-- Câu 9:
SELECT * FROM khach_hang
WHERE DIACHI = 'HOA XUAN' AND MAKH IN (SELECT DISTINCT MAKH FROM dat_phong);

-- Câu 10: 
SELECT p.MAPHONG, p.LOAIPHONG, p.SOKHACHTOIDA, p.GIAPHONG, COUNT(dp.MAKH) SoLanDat 
FROM phong p JOIN dat_phong dp ON p.MAPHONG = dp.MAPHONG
WHERE TRANGTHAIDAT = 'DA DAT'
GROUP BY p.MAPHONG, p.LOAIPHONG, p.SOKHACHTOIDA, p.GIAPHONG
HAVING COUNT(dp.MAKH) > 2;